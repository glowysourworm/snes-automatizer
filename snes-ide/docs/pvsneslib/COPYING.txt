From pvsneslib 4.3, with some modifications for working in SNES-IDE